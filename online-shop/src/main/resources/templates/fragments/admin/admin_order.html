<div th:fragment="content">
  <h2 class="admin-h2">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏</h2>

  <div id="update-order-form" class="modal" style="display: none;">
    <div class="modal-content">
    <span class="close-button">&times;</span>
    <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
    <form action="/admin/orders/update" method="post">

      <input type="hidden" id="id" name="id">

      <div class="form-group">
        <label for="customerName">–í–∞—à–µ –∏–º—è:</label>
        <input type="text" id="customerName" name="customerName" required>
      </div>

      <div class="form-group">
        <label for="birthDate">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</label>
        <input type="date" id="birthDate" name="birthDate" required>
      </div>

      <div class="form-group">
        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required>
      </div>

      <div class="form-group">
        <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
        <input type="tel" id="phone" name="phone" required>
      </div>

      <div class="form-group">
        <label for="nickname">–¢–∞–Ω–∫–æ–≤—ã–π –Ω–∏–∫:</label>
        <input type="text" id="nickname" name="nickname" required>
      </div>

      <div id="products-container">
        <div class="form-group product-group">
          <label for="product">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä:</label>
          <select id="product" name="product" required onchange="updateForm()">
            <option value="" data-price="0" selected disabled>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä</option>
            <option th:each="product : ${products}" th:value="${product.id}" th:data-price="${product.price}" th:text="${product.title}"></option>
          </select>
          <label for="quantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
          <input id="quantity" type="number" name="quantity" min="0" value="" required oninput="this.value = this.value.replace(/[^0-9]/g, ''); updateForm();">
        </div>
      </div>

      <div class="form-group">
        <label for="paymentMethod">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</label>
        <select id="paymentMethod" name="paymentMethod">
          <option value="card">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</option>
          <option value="wallet">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∫–æ—à–µ–ª–µ–∫</option>
          <option value="crypto">–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞</option>
        </select>
      </div>

      <div class="form-group">
        <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
        <textarea id="comment" name="comment" rows="3"></textarea>
      </div>

      <div class="form-group">
        <label for="total-price">–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</label>
        <span id="total-price">0 —Ä—É–±.</span>
        <input type="hidden" id="total-price-input" name="totalPrice">
      </div>

      <button type="submit" class="submit-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
    </form>
    </div>
  </div>

  <table class="admin-table">
    <tr>
      <th>–ò–º—è</th>
      <th>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th>
      <th>–ü–æ—á—Ç–∞</th>
      <th>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</th>
      <th>–ù–∏–∫</th>
      <th>–û–ø–ª–∞—Ç–∞</th>
      <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
      <th>–¢–æ–≤–∞—Ä</th>
      <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
      <th>–ò—Ç–æ–≥–æ</th>
      <th>–î–µ–π—Å—Ç–≤–∏—è</th>
    </tr>
    <tr th:each="order : ${orders}" id="order-row-[[${order.id}]]">
      <td th:text="${order.name}"></td>
      <td th:text="${order.birthDate}"></td>
      <td th:text="${order.email}"></td>
      <td th:text="${order.phone}"></td>
      <td th:text="${order.nickname}"></td>
      <td th:text="${order.paymentMethod}"></td>
      <td th:text="${order.comment}"></td>
      <td th:text="${order.product}"></td>
      <td th:text="${order.quantity}"></td>
      <td th:text="${order.totalPrice}"></td>
      <td>
        <button type="button" onclick="openUpdateForm(this)"
          th:attr="id=${order.id}, name=${order.name}, email=${order.email}, birthDate=${order.birthDate}, phone=${order.phone},
          nickname=${order.nickname}, paymentMethod=${order.paymentMethod}, comment=${order.comment}, product=${order.product},
          quantity=${order.quantity}, totalPrice=${order.totalPrice}">
          ‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        </button>
        <button class="delete-button" th:attr="data-id=${order.id}" onclick="confirmDeleteOrder(this)">üóë –£–¥–∞–ª–∏—Ç—å</button>
      </td>
    </tr>
  </table>

  <script>
    document.querySelectorAll('.close-button').forEach(button => {
      button.addEventListener('click', function () {
        document.getElementById('update-order-form').style.display = 'none';
      });
    });

    function openUpdateForm(button) {
      document.getElementById('id').value = button.getAttribute('id')
      document.getElementById('customerName').value = button.getAttribute('name');
      document.getElementById('birthDate').value = button.getAttribute('birthDate');
      document.getElementById('email').value = button.getAttribute('email');
      document.getElementById('phone').value = button.getAttribute('phone');
      document.getElementById('nickname').value = button.getAttribute('nickname');
      document.getElementById('paymentMethod').value = button.getAttribute('paymentMethod');
      document.getElementById('comment').value = button.getAttribute('comment');
      document.getElementById('product').value = button.getAttribute('product');
      document.getElementById('quantity').value = button.getAttribute('quantity');
      document.getElementById('total-price').textContent = button.getAttribute('totalPrice') + " —Ä—É–±."
      document.getElementById('total-price-input').value = button.getAttribute('totalPrice')

      document.getElementById('update-order-form').style.display = 'flex';
    }

    function confirmDeleteOrder(button) {
      let orderId = button.getAttribute("data-id");
      if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?")) {
        window.location.href = "/admin/orders/delete/" + orderId;
      }
    }
    document.addEventListener("DOMContentLoaded", function () {
      let productSelect = document.getElementById("product");
      let quantityInput = document.getElementById("quantity");
      let totalPriceField = document.getElementById("total-price");
      let totalPriceInput = document.getElementById("total-price-input")

      function updateForm() {
        let selectedOption = productSelect.options[productSelect.selectedIndex];
        let pricePerUnit = parseFloat(selectedOption.getAttribute("data-price").toString().replace(/,/g,"")) || 0;
        let quantity = parseInt(quantityInput.value) || 0;
        let total = pricePerUnit * quantity;
        totalPriceField.textContent = total + " —Ä—É–±.";
        totalPriceInput.value = total
      }

      productSelect.addEventListener("change", updateForm);
      quantityInput.addEventListener("input", updateForm);

      updateForm();
    });
  </script>

</div>